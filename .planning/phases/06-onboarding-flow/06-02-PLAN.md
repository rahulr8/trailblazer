---
phase: 06-onboarding-flow
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - components/auth/PermissionsScreen.tsx
  - components/auth/NotificationPermissionScreen.tsx
  - app/_layout.tsx
  - components/auth/CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "Health permission decline shows warning dialog before proceeding"
    - "Push notification permission screen appears after health permission screen"
    - "Push notification decline proceeds directly without warning"
    - "Partial completion (login done, permissions not done) resumes at permissions on next launch"
    - "Returning authenticated users with completed permissions skip directly to main app tabs"
  artifacts:
    - path: "components/auth/PermissionsScreen.tsx"
      provides: "Health permission with decline warning dialog"
      contains: "Alert.alert"
    - path: "components/auth/NotificationPermissionScreen.tsx"
      provides: "Push notification permission screen with accept/decline"
      contains: "Stay motivated"
    - path: "app/_layout.tsx"
      provides: "Two-step permissions flow: health -> notifications -> main app"
      contains: "NotificationPermissionScreen"
  key_links:
    - from: "app/_layout.tsx"
      to: "components/auth/PermissionsScreen.tsx"
      via: "Conditional render when !hasCompletedHealthPermission"
      pattern: "PermissionsScreen"
    - from: "app/_layout.tsx"
      to: "components/auth/NotificationPermissionScreen.tsx"
      via: "Conditional render when !hasCompletedNotificationPermission"
      pattern: "NotificationPermissionScreen"
    - from: "components/auth/PermissionsScreen.tsx"
      to: "Alert.alert"
      via: "Decline button handler triggers native dialog"
      pattern: "Alert.alert"
---

<objective>
Add health permission warning dialog, create push notification permission screen, and wire both into the _layout.tsx routing flow with partial completion tracking.

Purpose: Complete the permission flow so users see Health -> Push Notification screens after login, with proper decline handling and AsyncStorage-based resume behavior.
Output: PermissionsScreen with decline warning, new NotificationPermissionScreen, and updated _layout.tsx routing with partial completion support.
</objective>

<execution_context>
@/Users/turbolaunch/.claude/get-shit-done/workflows/execute-plan.md
@/Users/turbolaunch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-onboarding-flow/06-CONTEXT.md
@.planning/phases/06-onboarding-flow/06-RESEARCH.md
@.planning/phases/06-onboarding-flow/06-01-SUMMARY.md
@components/auth/PermissionsScreen.tsx
@app/_layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add health permission decline warning and create NotificationPermissionScreen</name>
  <files>
    components/auth/PermissionsScreen.tsx
    components/auth/NotificationPermissionScreen.tsx
  </files>
  <action>
**Install expo-notifications first:**
Run `npx expo install expo-notifications`

**PermissionsScreen.tsx** — Add warning dialog on health permission decline:
- Import `{ Alert }` from react-native
- Remove the `AsyncStorage.setItem(PERMISSIONS_COMPLETE_KEY, "true")` from `finishPermissions` — the parent `_layout.tsx` handles flag setting via onComplete callback. Change `finishPermissions` to simply call `onComplete?.()`.
- Rename `finishPermissions` to something clearer like `handleSkip` or keep it but remove the AsyncStorage logic (parent handles it).
- Change the decline button's onPress from calling `finishPermissions` directly to calling a new `handleDecline` function:
  ```typescript
  const handleDecline = () => {
    Alert.alert(
      "Missing Out",
      "Without health data, you'll miss automatic activity tracking and accurate time logs. Sure?",
      [
        { text: "Go Back", style: "cancel" },
        { text: "Continue Anyway", style: "destructive", onPress: () => onComplete?.() },
      ]
    );
  };
  ```
- Update decline button text to: "No, don't use my health data" (already matches)
- Accept button calls `handleAccept` which requests health permission, then calls `onComplete?.()`

**NotificationPermissionScreen.tsx** — New component matching PermissionsScreen layout:
- Same overall layout as PermissionsScreen (centered content with RotatingLogo, footer with buttons)
- Import `* as Notifications from 'expo-notifications'`
- Title: "Stay motivated."
- Body: "Giving permission to deliver notifications will help make sure you never miss a day!"
- Accept button ("Yes, I agree"): calls `Notifications.requestPermissionsAsync({ ios: { allowAlert: true, allowBadge: true, allowSound: true } })`, then `onComplete?.()`
- Decline button ("No, don't notify me"): calls `onComplete?.()` directly — NO warning dialog per user decision
- Wrap Notifications call in try/catch (fails gracefully on simulator)
- Props: `{ onComplete?: () => void }`
- Use same styles as PermissionsScreen for visual consistency
  </action>
  <verify>
Run `bunx tsc --noEmit` — no type errors. Verify both components render correctly with correct copy.
  </verify>
  <done>
PermissionsScreen shows Alert.alert warning dialog when user declines health permission. NotificationPermissionScreen exists with accept/decline buttons, requesting push notification permissions on accept and proceeding without warning on decline.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire two-step permission flow into _layout.tsx with partial completion tracking</name>
  <files>
    app/_layout.tsx
    components/auth/CLAUDE.md
  </files>
  <action>
**app/_layout.tsx** — Update routing to support Health -> Push Notification flow with partial completion:
- Add new AsyncStorage key: `const HEALTH_PERMISSION_KEY = "@trailblazer_health_permission_seen";` (tracks if health permission screen was shown, separate from overall `PERMISSIONS_KEY`)
- Keep existing `PERMISSIONS_KEY` as the final "all permissions complete" flag
- Add state: `const [hasSeenHealthPermission, setHasSeenHealthPermission] = useState(false);`
- Load `HEALTH_PERMISSION_KEY` in the `loadFlags` useEffect alongside other flags
- Import `NotificationPermissionScreen from "@/components/auth/NotificationPermissionScreen"`

Update the permission routing block (currently lines 111-118):
```typescript
// After user is authenticated but permissions not complete:
if (!hasSeenHealthPermission) {
  return (
    <>
      <PermissionsScreen onComplete={() => {
        AsyncStorage.setItem(HEALTH_PERMISSION_KEY, "true").catch(() => {});
        setHasSeenHealthPermission(true);
      }} />
      <StatusBar style="auto" />
    </>
  );
}

if (!hasCompletedPermissions) {
  return (
    <>
      <NotificationPermissionScreen onComplete={handlePermissionsComplete} />
      <StatusBar style="auto" />
    </>
  );
}
```

- Update sign-out cleanup (lines 74-81) to also clear `HEALTH_PERMISSION_KEY`:
  `AsyncStorage.multiRemove([ONBOARDING_KEY, PERMISSIONS_KEY, HEALTH_PERMISSION_KEY])`
- Also reset `setHasSeenHealthPermission(false)` on sign out

This ensures:
- First-time: Welcome -> Login -> Health Permission -> Push Permission -> Main App
- Partial completion (exits after health): Next launch skips to Push Permission
- Returning authenticated + all complete: Skip to main app

**components/auth/CLAUDE.md** — Update documentation:
- Document OnboardingScreen skip button
- Document RotatingLogo animation
- Document PermissionsScreen health decline warning dialog
- Document NotificationPermissionScreen
- Document Terms & Conditions link on LoginScreen
- Document the two-step permission flow with partial completion
  </action>
  <verify>
Run `bunx tsc --noEmit` — no type errors. Verify the routing flow:
1. Without any flags set: shows OnboardingScreen
2. After onboarding complete + not authenticated: shows LoginScreen
3. After auth + no health permission flag: shows PermissionsScreen (health)
4. After auth + health done + no permissions complete flag: shows NotificationPermissionScreen
5. After auth + all flags set: shows main app tabs
  </verify>
  <done>
_layout.tsx implements two-step permission flow (Health -> Push Notifications) with partial completion tracking via AsyncStorage. Returning users resume at the correct permission screen. Sign out clears all flags. CLAUDE.md updated with full onboarding flow documentation.
  </done>
</task>

</tasks>

<verification>
1. `bunx tsc --noEmit` passes with zero errors
2. Health permission decline triggers Alert.alert warning dialog with "Go Back" and "Continue Anyway" buttons
3. Push notification permission screen shows after health permission screen
4. Push notification decline proceeds directly without warning
5. Partial completion (exit after health permission) resumes at notification permission on next launch
6. Full completion (both permissions done) skips directly to main app tabs
7. Sign out clears all onboarding/permission flags
8. AsyncStorage keys used: `@trailblazer_onboarding_seen`, `@trailblazer_health_permission_seen`, `@trailblazer_permissions_complete`
</verification>

<success_criteria>
- Health permission decline shows native warning dialog before proceeding
- NotificationPermissionScreen renders with correct copy and button labels
- Two-step permission flow wired into _layout.tsx: Health -> Notifications -> Main App
- Partial completion tracking works via separate AsyncStorage keys
- No type errors, no regressions to existing auth/onboarding flow
</success_criteria>

<output>
After completion, create `.planning/phases/06-onboarding-flow/06-02-SUMMARY.md`
</output>
